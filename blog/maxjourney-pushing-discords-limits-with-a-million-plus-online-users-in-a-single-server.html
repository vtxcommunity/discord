<!DOCTYPE html><!-- Last Published: Tue Dec 19 2023 07:48:59 GMT+0000 (Coordinated Universal Time) --><html data-wf-domain="discordpages.webflow.io" data-wf-page="6102fadda3eb27bb56da0f57" data-wf-site="5f8dd67f8fdd6f51f0b50904">
<!-- Mirrored from discord.com/blog/maxjourney-pushing-discords-limits-with-a-million-plus-online-users-in-a-single-server by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 02 Jan 2024 08:23:15 GMT -->
<head><meta charset="utf-8"/><title>Maxjourney: Pushing Discord’s Limits with a Million+ Online Users in a Single Server</title><meta content="In this post, we’ll talk about some of the ways we’ve scaled individual Discord servers from tens of thousands of concurrent users to approaching two million concurrent users in the past few years." name="description"/><meta content="Maxjourney: Pushing Discord’s Limits with a Million+ Online Users in a Single Server" property="og:title"/><meta content="In this post, we’ll talk about some of the ways we’ve scaled individual Discord servers from tens of thousands of concurrent users to approaching two million concurrent users in the past few years." property="og:description"/><meta content="https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/62a281f083081c68ebb94672_Discord%20HQ%20-%203.png" property="og:image"/><meta content="Maxjourney: Pushing Discord’s Limits with a Million+ Online Users in a Single Server" property="twitter:title"/><meta content="In this post, we’ll talk about some of the ways we’ve scaled individual Discord servers from tens of thousands of concurrent users to approaching two million concurrent users in the past few years." property="twitter:description"/><meta content="https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/62a281f083081c68ebb94672_Discord%20HQ%20-%203.png" property="twitter:image"/><meta property="og:type" content="website"/><meta content="summary_large_image" name="twitter:card"/><meta content="width=device-width, initial-scale=1" name="viewport"/><link href="../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/css/discordpages.7ab087c99.css" rel="stylesheet" type="text/css"/><script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script><link href="../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/60ae916347747e71167e21cc_favicon.png" rel="shortcut icon" type="image/x-icon"/><link href="../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/5f91fae62cc821206588b837_Frame%20246.png" rel="apple-touch-icon"/><link href="rss.xml" rel="alternate" title="RSS Feed" type="application/rss+xml"/><!-- Localize integration code -->
<script src="../../ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="../../global.localizecdn.com/localize.js"></script>
<script src="../webflow-scripts/head.js"></script>
<style>
  .nav-bar-hack {
  	bottom: 0px !important;
    height: auto !important;
  }
  
  body a.w-webflow-badge {
    display: none !important;
  }
  
  body {
  	text-rendering: optimizeLegibility;
  }
  
  @media screen and (max-width: 476px) {
    .hide-on-mobile {
      display: none;
    }
  }
  
  .hr-style {
  border: 0;
  height: 8px;
  background-color: #F0F0F0;
  margin: 20px 0px;
  }
  
  .BlogBodyQuote {
  grid-column: 2/-1;
  font-size: 24px;
  line-height: 36px;
  padding: 0px 0px 15px 40px;
  font-style: italic;
  margin: 40px 0px 50px 0px;
}

.quote-text {
  width: 100%;
  margin-top: 10px;
}

.quote-icon {
  position: relative;
  top: 16px;
}

footer.quote-footer {
  font-size: 16px;
  margin-top: 20px;
  font-style: normal;
}
</style>

<style>
.language{
    display:flex;
    user-select: none;
}
.language .lang-container {
    position: relative;
}

.language .lang-selector-container {
    display: flex;
    align-items: center;
    cursor: pointer;
}

.language .locale-container{
    display: flex;
    align-items: center;
}

.language .flag {
    width: 24px;
    height: 16px;
    margin-right: 8px;
}

.language .selector-language-name{
    color: #fff;
    font-size: 14px;
    line-height: 18px;
}

.language .arrow-icon{
    padding-left: 8px;
}

.language .lang-dropdown-container {
    z-index: 10;
    bottom: 100%;
    margin-bottom: 8px;
    position: absolute;
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 1px 1px rgb(0 0 0 / 10%);
    overflow: hidden;
    display: none;
}

.language .lang-dropdown {
    max-height: 320px;
    min-width: 150px;
    overflow-x: hidden;
    overflow-y: auto;
    overscroll-behavior: contain;
}

.language .dropdown-item{
    padding: 8px;
}

.language .dropdown-clickable{
    cursor: pointer;
}

.language .dropdown-language-name{
    color: #23272a;
    font-size: 14px;
    line-height: 18px;
}

.flag-ru{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4da57001e8f59b8a77_62cb46f39e6ac4c46ce39566_ru.png);
}

.flag-bg{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cdbc0dc0fb5f55e3098f_6257c2a1e7544e303083b2b1_bolg.png);
}
.flag-cs{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4c83827a1284afe239_62cb46f1254305732a01676d_cs.png);
}
.flag-da{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4ad6ee377e0df4cde6_62cb46f16128094022db6768_da.png);
}
.flag-de{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4aa35fe71fedf5e95f_62cb46f1c50496ce73c40d99_de.png);
}
.flag-en-GB {
    content:url("https://assets-global.website-files.com/6257adef93867e50d84d30e2/62d01c2078d11b68a1633276_Rectangle 1 (3).svg");
}
.flag-el{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4ca5700115ec9b8a67_62cb46f17c26b5fe5a53876f_el.png);
}
.flag-en-US{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cdbc488f5f603e7ecd2a_6257bf8b5ba300233705a542_en.png);
}
.flag-en{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cdbc488f5f603e7ecd2a_6257bf8b5ba300233705a542_en.png);
}
.flag-es{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4b7670687b935aaed4_62cb46f14edab1b0029593fc_es-ES.png);
}
.flag-fi{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb48951dec0cce94a2b1_62cb46f1921c0cf82fc59da7_fi.png);
}
.flag-fr{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4a01339d451d474860_62cb46f1544a7ab7c66e9ccb_fr.png);
}
.flag-hi{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb47b3070262fdccd2a6_62cb46f13fcb6e76c05b504e_hi.png);
}
.flag-hr{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4764813ee14c33c45f_62cb46f1aeebe9064763c90c_hr.png);
}
.flag-hu{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb486b18c7334c564b9a_62cb46f19e6ac41dcce39561_hu.png);
}
.flag-it{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb47fcf6b11ce186dd29_62cb46f1bd099a25f8f77ea4_it.png);
}
.flag-ja{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb49fa4234bc13a595aa_62cb46f1e819841940bec47d_ja.png);
}
.flag-ko{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4b6b18c7266d564ba3_62cb46f125430509b9016776_ko.png);
}
.flag-lt{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4bc5fa8c17a80ae4c4_62cb46f14edab152b8959405_lt.png);
}
.flag-nl{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4d6b18c71a53564bac_62cb46f3e00ff80959abff2a_nl.png);
}
.flag-no{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4d29670fb8a9998a06_62cb46f37c26b5e22453877d_no.png);
}
.flag-pl{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4fd9e48ce2224e71b3_62cb46f3c504963019c40db7_pl.png);
}
.flag-pt-BR{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4d41e0514ceaeb0814_62cb46f3d809bc2503e62bec_pt-BR.png);
}
.flag-ro{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4b7b2666d9520e434e_62cb46f36e94d725ce411ab6_ro.png);
}
.flag-sv{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb5036a202f7044eb402_62cb46f49e6ac47674e39567_sv-SE.png);
}
.flag-th{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb502ab71d0c254b8e0c_62cb46f465c529bf26e211a1_th.png);
}
.flag-tr{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4f41e0515a89eb082a_62cb46f4e819848178bec4d1_tr.png);
}
.flag-uk{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4f36a20273d04eb401_62cb46f37c26b54f6a53877f_uk.png);
}
.flag-vi{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4f00801f3750f4834e_62cb46f4e819840d89bec4d2_vi.png);
}
.flag-zh-Hans{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb5010e73af938ef607e_62cb46f49e6ac45f35e39568_zh-CN.png);
}
.flag-zh-TW{
    content:url(../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4fd354ea61ac8db41c_62cb46f33fcb6ea5c95b5069_zh-TW.png);
}
</style>

<style>
.btn-wrapper a {
  color: #fff ;
}

/*
strong {
  font-weight: 700!important;
  font-size: 32px!important;
}
*/
</style>

</head><body><div style="background-color:#5865f2" class="header-blue-blog"><div data-w-id="268ebfa3-e656-b800-3b97-3f7bdfa2ec4d" class="blog-navbar"><a href="../blog.html" class="blog-brand-copy w-nav-brand"><img src="https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/613b8fc3834b2bd42157bc04_blogwhite.svg" loading="lazy" alt="Discord"/></a><div data-collapse="medium" data-animation="over-right" data-duration="400" data-easing="ease" data-easing2="ease" role="banner" class="navbar-5 w-nav"><div class="container-790 w-container"><nav role="navigation" class="blog-nav w-nav-menu"><div data-delay="100" data-hover="true" class="w-dropdown"><div class="w-dropdown-toggle"><img src="https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/635157e8f94a8580bcbb3e32_Shape.svg" loading="lazy" alt="" class="icon mobile"/><img src="https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/614275ac3d35134cb2a96b63_down.svg" loading="lazy" alt="" class="icon white"/><div class="blog-nav-item">COLLECTIONS</div></div><nav class="dropdown-list w-dropdown-list"><div class="w-dyn-list"><div role="list" class="w-dyn-items"><div role="listitem" class="w-dyn-item"><a href="../category/community.html" class="dropdown-link w-dropdown-link">Community</a></div><div role="listitem" class="w-dyn-item"><a href="../category/company.html" class="dropdown-link w-dropdown-link">Discord HQ</a></div><div role="listitem" class="w-dyn-item"><a href="../category/engineering.html" class="dropdown-link w-dropdown-link">Engineering &amp; Developers</a></div><div role="listitem" class="w-dyn-item"><a href="../category/how-to-discord.html" class="dropdown-link w-dropdown-link">How to Discord</a></div><div role="listitem" class="w-dyn-item"><a href="../category/safety.html" class="dropdown-link w-dropdown-link">Policy &amp; Safety</a></div><div role="listitem" class="w-dyn-item"><a href="../category/product.html" class="dropdown-link w-dropdown-link">Product &amp; Features</a></div></div></div></nav></div><a href="../blog-featured.html" class="blog-nav-item w-nav-link">Featured</a><a href="../index.html" class="blog-nav-item w-nav-link">Discord.com</a><div class="w-embed"><form action="https://discord.com/blog/search" class="form-search w-form" style="display: flex">
<input type="search" class="text-field w-input" maxlength="256" name="query" placeholder="Search…" id="search" required="">
<input type="submit" value="" class="btn-search w-button">
</form>

<style> 
form.form-search.w-form:focus-within {
    border: 1px solid #fff;
}
</style></div><form action="https://discord.com/search" class="form-search w-form"><input type="search" class="text-field w-input" maxlength="256" name="query" placeholder="Search…" id="search" required=""/><input type="submit" value="" class="btn-search w-button"/></form></nav><div class="w-nav-button"><img src="https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/60b6ad79b75c18f025626c71_menuicon.svg" loading="lazy" alt="Menu" class="image-14"/></div></div></div></div></div><div style="background-color:#5865f2" class="blog-home-hero-header"></div><div class="blog-featured-section"><div class="blog-hero-container hero-offset w-dyn-list"><div role="list" class="collection-list w-dyn-items"><div role="listitem" class="collection-item-4 w-dyn-item"><div class="div-block-15"><img src="../../assets-global.website-files.com/5f9072399b2640f14d6a2bf4/62a281f083081c68ebb94672_Discord%20HQ%20-%203.png" loading="lazy" alt="" sizes="(max-width: 767px) 92vw, (max-width: 991px) 90vw, (max-width: 1279px) 91vw, (max-width: 1919px) 92vw, 1368px" srcset="https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/62a281f083081c68ebb94672_Discord%20HQ%20-%203-p-500.png 500w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/62a281f083081c68ebb94672_Discord%20HQ%20-%203-p-800.png 800w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/62a281f083081c68ebb94672_Discord%20HQ%20-%203-p-1080.png 1080w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/62a281f083081c68ebb94672_Discord%20HQ%20-%203-p-1600.png 1600w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/62a281f083081c68ebb94672_Discord%20HQ%20-%203-p-2000.png 2000w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/62a281f083081c68ebb94672_Discord%20HQ%20-%203-p-2600.png 2600w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/62a281f083081c68ebb94672_Discord%20HQ%20-%203-p-3200.png 3200w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/62a281f083081c68ebb94672_Discord%20HQ%20-%203.png 3600w" class="image-19"/></div><div class="blog-hero-heading-section"><a href="../category/engineering.html" class="blog-hero-category">Engineering &amp; Developers</a><a href="maxjourney-pushing-discords-limits-with-a-million-plus-online-users-in-a-single-server.html" aria-current="page" class="blog-hero-heading w--current">Maxjourney: Pushing Discord’s Limits with a Million+ Online Users in a Single Server</a></div></div></div></div></div><div class="blog-post-container new"><div class="column-wrapper w-row"><div class="column-3 w-col w-col-2 w-col-stack"><div class="the-author-section"><img alt="" loading="lazy" width="72" src="../../assets-global.website-files.com/5f9072399b2640f14d6a2bf4/6539425ec5bfa7998292d6aa_Screen%20Shot%202023-10-25%20at%2011.29.10%20AM.png" sizes="72px" srcset="https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/6539425ec5bfa7998292d6aa_Screen%20Shot%202023-10-25%20at%2011.29.10%20AM-p-500.png 500w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/6539425ec5bfa7998292d6aa_Screen%20Shot%202023-10-25%20at%2011.29.10%20AM-p-800.png 800w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/6539425ec5bfa7998292d6aa_Screen%20Shot%202023-10-25%20at%2011.29.10%20AM.png 962w" class="image-22"/><div><div class="blog-post-author">Yuliy Pisetsky</div><div class="blog-post-author-name">October 25, 2023</div></div></div><div class="tag-section w-condition-invisible"><div class="divider-bar-copy"></div><div class="tags-sections-head">Tags</div><div class="collection-list-wrapper-2 w-dyn-list"><div class="empty-state w-dyn-empty"></div></div></div></div><div class="column-4 w-col w-col-8 w-col-stack"><div id="heading-1" class="rich-wrapper"><div class="blog-post-content w-richtext"><p>It&#x27;s been a while since we <a href="using-rust-to-scale-elixir-for-11-million-concurrent-users.html">last wrote</a> about some of the things we&#x27;ve done to scale our Elixir systems to meet the needs of our community. Since then, not only has the overall size of Discord&#x27;s user base grown massively, but our largest communities have individually grown even faster. With that growth, those servers started slowing down and creeping ever closer to their throughput limits. As that’s happened, we’ve continued to find many improvements to keep making them faster and pushing the limits out further. In this post we’ll talk about some of the ways we’ve scaled individual Discord servers from tens of thousands of concurrent users to approaching two million concurrent users in the past few years.</p></div></div><div class="btn-wrapper w-condition-invisible"><a href="#" class="btn-blog w-dyn-bind-empty w-button"></a></div><div id="heading-2" class="rich-wrapper"><div class="blog-post-content w-richtext"><h2>Elixir as a fanout system</h2><p>Whenever something happens on Discord, such as a message being sent, or someone joining a voice channel, we need to update the UI in the client of everyone who’s online that is in the same server (also known as a “guild”). We use a single Elixir process per guild as a central routing point for everything happening on that server, and another process (a “session”) for each connected user’s client. The guild process keeps track of the sessions for users who are members of that guild, and is responsible for fanning out actions to those sessions. Once the sessions receive those updates, they’ll forward them over a websocket connection to the client.</p><p>Some actions go to everyone in the server, while others require checking permissions, which requires knowing the user’s roles as well as information about the roles and channels on that server. Why not have multiple guild processes per server? Some things need a full view: showing the list of people in a voice channel, or maintaining channel member lists, for instance.</p><figure class="w-richtext-figure-type-image w-richtext-align-fullwidth" style="max-width:1920pxpx" class="w-richtext-align-fullwidth w-richtext-figure-type-image"><div><img src="../../assets-global.website-files.com/5f9072399b2640f14d6a2bf4/65383f8878c471448f670f11_Fanout%20img%20002.png" loading="lazy" alt=""/></div><figcaption>How a message flows from the sender (left) through Discord’s systems to other users and bots in the same server. This post focuses on the Guild elixir process in the middle. Dotted lines indicate that some users in the server may not have permissions to see the message, so should not receive it.</figcaption></figure><p>The nature of fanning out messages means the odds are against us: the amount of activity in a guild is proportional to the number of people in that server. On top of that, the amount of work needed to fan out a single message is proportional to the number of people online in that server too. That means that the amount of work needed to handle a discord server grows quadratically with the size of the server: If a server has 1000 people online, and they all were to say “I love jello” once, that’s 1 million notifications. The same thing with 10,000 people is 100 million notifications. With 100,000 people that’s 10 billion notifications to deliver!</p><p>In addition to overall throughput concerns, some operations end up getting slower the larger a server is. Ensuring that we can keep almost all operations quick is important to the server feeling like it&#x27;s responsive: when a message is sent, others should see it right away; when someone joins a voice channel, they should be able to start participating right away. Taking multiple seconds to process an expensive operation hurts that experience.</p><p>Knowing these challenges were standing in our way, how did we get to supporting Midjourney, which has over 10 million members, of whom over 1 million are online (and thus have a session connected to the guild) at any given time? First, it was a matter of being able to understand how our systems were performing. Once we had that data, it was a matter of finding opportunities to improve both throughput and responsiveness.</p></div></div><div id="heading-3" class="rich-wrapper"><div class="blog-post-content w-richtext"><h2>Understanding how our systems perform</h2><p>Before being able to make our systems better, ensuring that we have a good sense of what they’re spending their time and RAM on is critical.</p><h3>Wall time analysis</h3><p>The simplest way of understanding what an Elixir process is doing is to take a stack trace with Process.info(pid, :current_stacktrace). If a process is stuck waiting on something, this is a great way to find out what. If its running code, then it&#x27;s less simple, but still useful. Grabbing a thousand stacktraces, sleeping 100 milliseconds between each one, takes a couple minutes and gives you a pretty good idea of what that process is doing. This can be done for any process in an elixir system to get insights into it, and requires very little effort.</p><p>However, sometimes richer information is needed. For this, we instrumented the event processing loop of the guild processes to record how many of each type of message we receive, as well as the max/min/average/total time to process these. This means we could ignore all of the operations which account for &lt; 1% of the total time unless they&#x27;re extremely bursty. In addition to ruling out cheap operations, it helped highlight the operations which are most expensive. From there it was a matter of looking at code and stack traces to understand <em>why</em> those operations were slow, and what could be done about it. In the graph below, the impact of a change targeting how we handle presence updates can be clearly seen, giving us confidence in knowing that our theories are correct and helping guide us toward the next area of concern.</p><figure class="w-richtext-figure-type-image w-richtext-align-fullwidth" style="max-width:2200pxpx" class="w-richtext-align-fullwidth w-richtext-figure-type-image"><div><img src="../../assets-global.website-files.com/5f9072399b2640f14d6a2bf4/65383fa42958fff301795b73_Screenshot%20Aug%2029%20Maxjourney.png" loading="lazy" alt="A line chart labeled &quot;Guild % of time busy by message type.&quot;"/></div><figcaption>Breaking out time spent by type of operation allows seeing the impact of specific changes more clearly. Here is a significant performance win on processing of presence updates (light blue line), preceded a couple days before by a smaller performance win on processing normal messages (yellow line) a couple days before.</figcaption></figure><h3>Process Heap Memory analysis</h3><p>In addition to understanding where guilds are spending their time, understanding how they&#x27;re using memory is important, too. For us, memory not only affects the type of machines we should use, but also the performance of the garbage collector. For this, erts_debug.size can help. However, that function is extremely slow for large objects. To make its cost reasonable, we wrote a <a href="https://github.com/discord/memory_size">helper library</a> which samples large (non-struct) maps and lists to produce estimated memory usage rather than walking every single element.</p><p>This was helpful not only in understanding GC performance, but in finding which fields were worth focusing on for optimizing, and which were ultimately irrelevant.</p></div></div><div id="heading-4" class="rich-wrapper"><div class="blog-post-content w-richtext"><p>Once we had a good sense of where guild processes were spending their time, we could start coming up with strategies for keeping the guild process away from being 100% busy. In some cases it was just a matter of rewriting an inefficient implementation more efficiently. However that could only get us so far. We needed more radical changes.</p><h2>Passive sessions - avoiding unnecessary work</h2><p>One of the best ways of pushing a throughput bottleneck out is to just do less work. One way we did this was by considering the needs of our client application. In our original topology, every user receives every action which they&#x27;re allowed to see in all of their guilds. However, some users are in many guilds, and may not even click in to check out what&#x27;s happening in some of those. What if we didn&#x27;t send them everything until they clicked in? We wouldn&#x27;t need to bother checking their permissions for every message and would send their client much less data as a result. We called this a &quot;passive&quot; connection, and kept it in a separate list from the &quot;active&quot; connections that should receive all of the data. This ended up working even better than we expected: around 90% of user-guild connections in large servers were passive, resulting in the fanout work being 90% less expensive! This got us some breathing room, but naturally as communities kept growing it wouldn&#x27;t be enough (a 10x reduction in work gives us a ~3x win in maximum community size).</p><h2>Relays - splitting fanout across multiple machines</h2><p>One of the standard techniques for extending a single core throughput limit is to split the work across multiple threads (or processes, to use the Elixir term). This idea led us to build a system called &quot;relays&quot; which sits between guilds and the users&#x27; sessions. By splitting the work of handling those sessions across multiple relays instead of it all being done by a single process, we could allow a single guild to use more resources to serve a large community. While some work would still need to be done in the main guild process, this got us to handling communities in the hundreds of thousands of members.</p><figure class="w-richtext-figure-type-image w-richtext-align-fullwidth" style="max-width:1920pxpx" class="w-richtext-align-fullwidth w-richtext-figure-type-image"><div><img src="../../assets-global.website-files.com/5f9072399b2640f14d6a2bf4/65384120babecef04669da7a_Fanout%20001.png" loading="lazy" alt="A chart representing a Guild tranferring to three separate relay sessions. One of the three Relay sessions splits off into two sessions, which move to Mobile and Desktop. The second Relay session moves to a mobile device. The third Relay session moves to a robot."/></div><figcaption>Relays maintain connections to the sessions instead of the guild, and are responsible for doing fanout with permission checks. We handle up to 15,000 connected sessions per relay.</figcaption></figure><p>Implementing this required identifying which operations were critical to do in the relays, which ones had to be done in the guild, and which ones could be done by either system. Once we had an idea of what was needed, the effort of refactoring to pull out logic that could be shared between the systems could begin. For example, most of the logic for how to do fanout was refactored into a library used both for guilds and relays. Some logic could not be shared like this, and different solutions were needed: voice state management was implemented by basically having the relay proxy all of the messages to the guild with minimal changes.</p><p>One of the more interesting design decisions we made when initially rolling out relays was to include the entire list of members in the state of each relay. This was good from a simplicity perspective: any member information needed was guaranteed to be available. Unfortunately, at Midjourney scale (many millions of members) this design started to make less and less sense: not only did we have dozens of copies of those tens of millions members sitting in RAM, but creating a new relay would require serializing and sending all of that member information to the new relay, stalling the guild for tens of seconds. To fix that, we added logic to identify the members that the relay actually needed to function, which was a tiny percentage of the overall members.</p></div></div><div id="heading-5" class="rich-wrapper"><div class="blog-post-content w-richtext"><h2>Keeping servers responsive</h2><p>In addition to ensuring we stayed within throughput limits, we also needed to make sure that servers stayed responsive. Again, looking at timing data was useful: here, focusing more on operations which have high per-call durations rather than high total durations was more impactful.</p><h3>Worker Processes + ETS</h3><p>One of the biggest culprits of unresponsiveness was operations which needed to run in the guild and iterate over all of the members. These are fairly rare, but do happen. For instance, when someone does an everyone ping, we need to know everyone who&#x27;s in the server that is able to see that message. But doing those checks can take many seconds. How can we handle that? Ideally we&#x27;d run that logic while the guild is busy processing other things, but Elixir processes don&#x27;t share memory nicely. So we needed a different solution.</p><p>One of the tools available in Erlang/Elixir for storing data in memory where processes can share it is <a href="https://www.erlang.org/doc/man/ets.html">ETS</a>. This is an in-memory database that supports the ability for multiple elixir processes to access it safely. While it’s less efficient than accessing data in the process heap, it’s still quite fast. It also has the benefit of reducing the size of the process heap, which reduces the latency of garbage collection.</p><p>We decided to create a hybrid structure for holding the list of members: We would store the list of members in ETS, which allows other processes to read it too, but also store a set of recent changes (inserts, updates, deletes) in the process heap. Since most members are not being updated all the time, the set of recent changes is a very small fraction of the overall set of members.</p><p>With the members in ETS, we can now create worker processes and pass them the ETS table identifier to work on when we have expensive operations. The worker process can handle the expensive part while the guild continues doing other work. See the code snippet for a simplified version of how we do this.</p><div class="w-embed w-script"><center><script src="../../gist.github.com/DiscordBlog/400f7c8c88b5851eaab18e011183c3ad.js"></script></div><p>One place where we use this is when we need to hand off a guild process from one machine to another (usually for maintenance or deploys). In that process, we need to spawn a new process to handle the guild on the new machine, then copy over the state of the old guild process to the new one, re-connect all connected sessions to the new guild process, and then process the backlog that built up during that operation. By using a worker process, we can send most of the members (which can be multiple GB of data) while the old guild process is still doing work, and thus cut off minutes of stalling every time we do a hand off.</p><h3>Manifold Offload</h3><p>Another idea we had for improving responsiveness (and also pushing out the throughput limit) was to extend <a href="https://github.com/discord/manifold">Manifold</a> (discussed in <a href="how-discord-scaled-elixir-to-5-000-000-concurrent-users.html">a previous blog post</a>) to use a separate “sender” process to do the fanout to recipient nodes (instead of having the guild process do it). This not only reduced the amount of work done by the guild process, but it would also insulate it from BEAM&#x27;s <a href="https://www.erlang.org/doc/reference_manual/processes#irregularities">backpressure</a> in case one of the network connections between guilds and relays were to back up temporarily (BEAM is the virtual machine which our Elixir code runs in). In theory this looked like it would be a quick win. Unfortunately, when we tried turning this feature (called Manifold Offload) on, we found that it actually led to a massive performance degradation. How could this be? We&#x27;re theoretically doing less work but the process is busier?</p><p>Looking more closely, we noticed that most of the extra work was related to garbage collection. Trying to understand how and why naturally needed more data. Here, the <a href="https://www.erlang.org/doc/man/erlang#trace-3">erlang.trace</a> function came to the rescue. This allowed us to get data about every time the guild process did a garbage collection, giving us insights into not only exactly how frequently it was happening, but also what triggered it.</p><p>Taking the information from those traces, and looking at <a href="https://github.com/erlang/otp/blob/6674ed5d5e9dc90675814e75dc835a60068253c9/erts/emulator/beam/erl_gc.c#L1441">BEAM’s garbage collection code</a>, we realized that the trigger condition for the major (full) garbage collection when manifold offload was enabled was the <a href="https://www.erlang.org/doc/apps/erts/garbagecollection#virtual-binary-heap">virtual binary heap</a>. The virtual binary heap is a feature which is designed to allow for freeing memory used by strings that are not stored inside the process heap, even when the process would otherwise not need to garbage collect. Unfortunately, our usage pattern meant that we would continually trigger garbage collection to reclaim a couple hundred kilobytes of memory, at the cost of copying a heap which was gigabytes in size, a trade-off which was clearly not worth it. Thankfully BEAM allowed us to tune this behavior using a process flag, <a href="https://www.erlang.org/doc/man/erlang#process_flag-2">min_bin_vheap_size</a>. Once we increased that to a few megabytes, the pathological garbage collection behavior disappeared, and we were then able to turn on manifold offload and observe a significant performance win.</p></div></div><div id="heading-6" class="rich-wrapper"><div class="blog-post-content w-richtext"><h3>Looking forward</h3><p>The optimizations mentioned above are the tip of the iceberg of a lot of other changes we’ve done to improve performance both for Midjourney and other huge servers. And, with the instrumentation mentioned above, we’re able to stay on top of new bottlenecks that arise as different communities grow and use Discord in new and exciting ways.</p></div></div><div id="heading-7" class="rich-wrapper"><div class="blog-post-content w-dyn-bind-empty w-richtext"></div></div><div id="heading-8" class="rich-wrapper"><div class="blog-post-content w-dyn-bind-empty w-richtext"></div></div><div id="heading-9" class="rich-wrapper"><div class="blog-post-content w-dyn-bind-empty w-richtext"></div></div><div id="heading-10" class="rich-wrapper"><div class="blog-post-content w-dyn-bind-empty w-richtext"></div></div></div><div class="column-desctop w-col w-col-2 w-col-stack"><div class="rich-content-right"><div class="paragraph-medium bot-marg">Contents</div><a href="#heading-1" class="title-menu-anchor">Intro</a><a href="#heading-2" class="title-menu-anchor">Elixir as a fanout system</a><a href="#heading-3" class="title-menu-anchor">Understanding how our systems perform</a><a href="#heading-4" class="title-menu-anchor">Pushing the throughput limits</a><a href="#heading-5" class="title-menu-anchor">Keeping servers responsive</a><a href="#heading-6" class="title-menu-anchor">Looking forward</a><a href="#heading-7" class="title-menu-anchor w-dyn-bind-empty"></a><a href="#heading-8" class="title-menu-anchor w-dyn-bind-empty"></a><a href="#heading-9" class="title-menu-anchor w-dyn-bind-empty"></a><a href="#heading-10" class="title-menu-anchor w-dyn-bind-empty"></a></div></div></div><div class="divider-bar"></div><div class="blog-column w-row"><div class="w-col w-col-3 w-col-medium-6"><div class="author-title">THE AUTHOR</div></div><div class="w-col w-col-9 w-col-medium-6"><div class="the-author-section footer"><img alt="" loading="lazy" width="47" src="../../assets-global.website-files.com/5f9072399b2640f14d6a2bf4/6539425ec5bfa7998292d6aa_Screen%20Shot%202023-10-25%20at%2011.29.10%20AM.png" sizes="96px" srcset="https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/6539425ec5bfa7998292d6aa_Screen%20Shot%202023-10-25%20at%2011.29.10%20AM-p-500.png 500w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/6539425ec5bfa7998292d6aa_Screen%20Shot%202023-10-25%20at%2011.29.10%20AM-p-800.png 800w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/6539425ec5bfa7998292d6aa_Screen%20Shot%202023-10-25%20at%2011.29.10%20AM.png 962w" class="blog-post-author-image-footer"/><div><div class="blog-post-author-footer">Yuliy Pisetsky</div><div class="blog-post-author-desc">Yuliy is a Staff Software Engineer at Discord.</div></div></div></div></div><div class="divider-bar"></div><div><div class="author-title">MORE FROM</div><div class="category-title-footer">Engineering &amp; Developers</div><div class="footer-more-from w-dyn-list"><div role="list" class="featured-small-list w-dyn-items w-row"><div role="listitem" class="collection-item-small blog w-dyn-item w-col w-col-4"><a href="pytest-daemon-10x-local-test-iteration-speed.html" class="link-block-4 w-inline-block"><img src="../../assets-global.website-files.com/5f9072399b2640f14d6a2bf4/6555194328bacbf541b78da4_Engineering%20-%202%20(1).png" loading="lazy" alt="" sizes="(max-width: 767px) 83vw, (max-width: 991px) 29vw, (max-width: 1439px) 30vw, 434.6625061035156px" srcset="https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/6555194328bacbf541b78da4_Engineering%20-%202%20(1)-p-500.png 500w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/6555194328bacbf541b78da4_Engineering%20-%202%20(1)-p-800.png 800w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/6555194328bacbf541b78da4_Engineering%20-%202%20(1)-p-1080.png 1080w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/6555194328bacbf541b78da4_Engineering%20-%202%20(1)-p-1600.png 1600w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/6555194328bacbf541b78da4_Engineering%20-%202%20(1)-p-2000.png 2000w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/6555194328bacbf541b78da4_Engineering%20-%202%20(1)-p-2600.png 2600w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/6555194328bacbf541b78da4_Engineering%20-%202%20(1)-p-3200.png 3200w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/6555194328bacbf541b78da4_Engineering%20-%202%20(1).png 3600w" class="blog-featured-small-image"/></a><a href="../category/engineering.html" class="blog-hero-category">Engineering &amp; Developers</a><a href="pytest-daemon-10x-local-test-iteration-speed.html" class="link-block-20 w-inline-block"><div class="blog-featured-title-small">pytest daemon: 10X Local Test Iteration Speed</div></a></div><div role="listitem" class="collection-item-small blog w-dyn-item w-col w-col-4"><a href="ddevs-celebrates-250k-members.html" class="link-block-4 w-inline-block"><img src="../../assets-global.website-files.com/5f9072399b2640f14d6a2bf4/65690639d911b0d8f5dc758e_DDevs_250k_blogheader.png" loading="lazy" alt="" sizes="(max-width: 767px) 83vw, (max-width: 991px) 29vw, (max-width: 1439px) 30vw, 434.6625061035156px" srcset="https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/65690639d911b0d8f5dc758e_DDevs_250k_blogheader-p-500.png 500w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/65690639d911b0d8f5dc758e_DDevs_250k_blogheader-p-800.png 800w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/65690639d911b0d8f5dc758e_DDevs_250k_blogheader-p-1080.png 1080w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/65690639d911b0d8f5dc758e_DDevs_250k_blogheader-p-1600.png 1600w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/65690639d911b0d8f5dc758e_DDevs_250k_blogheader.png 1800w" class="blog-featured-small-image"/></a><a href="../category/engineering.html" class="blog-hero-category">Engineering &amp; Developers</a><a href="ddevs-celebrates-250k-members.html" class="link-block-20 w-inline-block"><div class="blog-featured-title-small">The DDevs Server Celebrates 250k Members!</div></a></div><div role="listitem" class="collection-item-small blog w-dyn-item w-col w-col-4"><a href="authentication-outage.html" class="link-block-4 w-inline-block"><img src="../../assets-global.website-files.com/5f9072399b2640f14d6a2bf4/63178bf5d9f1714116f6a66d_Resources%20%26%20Education%20-%203.png" loading="lazy" alt="" sizes="(max-width: 767px) 83vw, (max-width: 991px) 29vw, (max-width: 1439px) 30vw, 434.6625061035156px" srcset="https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/63178bf5d9f1714116f6a66d_Resources%20%26%20Education%20-%203-p-500.png 500w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/63178bf5d9f1714116f6a66d_Resources%20%26%20Education%20-%203-p-800.png 800w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/63178bf5d9f1714116f6a66d_Resources%20%26%20Education%20-%203-p-1080.png 1080w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/63178bf5d9f1714116f6a66d_Resources%20%26%20Education%20-%203-p-1600.png 1600w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/63178bf5d9f1714116f6a66d_Resources%20%26%20Education%20-%203-p-2000.png 2000w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/63178bf5d9f1714116f6a66d_Resources%20%26%20Education%20-%203-p-2600.png 2600w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/63178bf5d9f1714116f6a66d_Resources%20%26%20Education%20-%203-p-3200.png 3200w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/63178bf5d9f1714116f6a66d_Resources%20%26%20Education%20-%203.png 3600w" class="blog-featured-small-image"/></a><a href="../category/engineering.html" class="blog-hero-category">Engineering &amp; Developers</a><a href="authentication-outage.html" class="link-block-20 w-inline-block"><div class="blog-featured-title-small">25% or 6 to 4: The 11/6/23 Authentication Outage</div></a></div></div></div></div></div><div class="footer-black"><div class="container-1180px-2"><div class="w-layout-grid grid-footer"><div id="w-node-_4154f574-5821-8ddb-f6fc-12aae7b6c861-e7b6c85e" class="vertical-flex"><div data-hover="false" data-delay="0" class="dropdown-3 w-dropdown"><div class="dropdown-toggle w-dropdown-toggle"><img src="https://assets-global.website-files.com/6257adef93867e50d84d30e2/6257bee91e6309a5a6f6b994_arrow.svg" loading="lazy" alt="" class="arrow"/><div>English, USA</div></div><nav class="dropdown-list-5 w-dropdown-list"><a href="#" class="dropdown-link-2 w-dropdown-link">български</a><a href="#" class="dropdown-link-2 czech w-dropdown-link">Čeština</a><a href="#" class="dropdown-link-2 dansk w-dropdown-link">Dansk</a><a href="#" class="dropdown-link-2 deutsch w-dropdown-link">Deutsch</a><a href="#" class="dropdown-link-2 greek w-dropdown-link">Ελληνικά</a><a href="#" class="dropdown-link-2 english w-dropdown-link">English, USA</a><a href="#" class="dropdown-link-2 spanish w-dropdown-link">Español</a><a href="#" class="dropdown-link-2 suomi w-dropdown-link">Suomi</a><a href="#" class="dropdown-link-2 french w-dropdown-link">Français</a><a href="#" class="dropdown-link-2 hindi w-dropdown-link">हिंदी</a><a href="#" class="dropdown-link-2 hrvatski w-dropdown-link">Hrvatski</a><a href="#" class="dropdown-link-2 magyar w-dropdown-link">Magyar</a><a href="#" class="dropdown-link-2 italiano w-dropdown-link">Italiano</a><a href="#" class="dropdown-link-2 japanese w-dropdown-link">日本語</a><a href="#" class="dropdown-link-2 korean w-dropdown-link">한국어</a><a href="#" class="dropdown-link-2 lithuanian w-dropdown-link">Lietuviškai</a><a href="#" class="dropdown-link-2 nederlands w-dropdown-link">Nederlands</a><a href="#" class="dropdown-link-2 norwegian w-dropdown-link">Norwegian</a><a href="#" class="dropdown-link-2 polski w-dropdown-link">Polski</a><a href="#" class="dropdown-link-2 brazilian-portuguese w-dropdown-link">Português do Brasil</a><a href="#" class="dropdown-link-2 romania w-dropdown-link">Română</a><a href="#" class="dropdown-link-2 ru w-dropdown-link">Русский</a><a href="#" class="dropdown-link-2 svenska w-dropdown-link">Svenska</a><a href="#" class="dropdown-link-2 thai w-dropdown-link">ไทย</a><a href="#" class="dropdown-link-2 turkey w-dropdown-link">Türkçe</a><a href="#" class="dropdown-link-2 ua w-dropdown-link">Українська</a><a href="#" class="dropdown-link-2 vietnamese w-dropdown-link">Tiếng Việt</a><a href="#" class="dropdown-link-2 chinese1 w-dropdown-link">中文</a><a href="#" class="dropdown-link-2 chinese w-dropdown-link">繁體中文</a></nav></div><div class="language"><div class="lang-container"><div id="locale-dropdown" class="lang-dropdown-container"><div class="lang-dropdown"></div></div><div class="lang-selector-container"><div class="locale-container"><img src="https://assets-global.website-files.com/plugins/Basic/assets/placeholder.60f9b1840c.svg" alt="" class="flag"/><div class="selector-language-name"></div></div><img src="https://assets-global.website-files.com/6257adef93867e50d84d30e2/6257bee91e6309a5a6f6b994_arrow.svg" loading="lazy" alt="" class="arrow-icon"/></div></div></div><div class="flex-horizontal top-soc"><a data-track="twitter" href="https://twitter.com/discord" target="_blank" class="link-s w-inline-block"><img src="https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/65814ad8d9f0b3d89c08fdad_X.svg" loading="lazy" alt="" class="image-49"/></a><a data-track="instagram" href="https://www.instagram.com/discord/" target="_blank" class="link-s w-inline-block"><img src="https://assets-global.website-files.com/6238e97f6441e30a13a52345/6436b5ef634f834a45100cff_svg4.svg" loading="lazy" alt="" class="image-49"/></a><a data-track="facebook" href="https://www.facebook.com/discord/" target="_blank" class="link-s w-inline-block"><img src="https://assets-global.website-files.com/6238e97f6441e30a13a52345/6436b5ef634f836372100cfc_svg5.svg" loading="lazy" alt="" class="image-49"/></a><a data-track="youtube" href="https://www.youtube.com/discord" target="_blank" class="link-s w-inline-block"><img src="https://assets-global.website-files.com/6238e97f6441e30a13a52345/6436b5ef634f83240a100cfe_svg6.svg" loading="lazy" alt="" class="image-49"/></a><a data-track="Tiktok" href="https://www.tiktok.com/@discord" target="_blank" class="link-s w-inline-block"><img src="https://assets-global.website-files.com/6257adef93867e50d84d30e2/6374a8122d8df285ddea0e9e_Tiktok (1).svg" loading="lazy" alt="" class="image-49"/></a></div></div><div id="w-node-_4154f574-5821-8ddb-f6fc-12aae7b6c8b6-e7b6c85e"><div class="paragraph-small top-marg font-blue">Product</div><a data-track="download" href="../download.html" class="link-footer">Download</a><a data-track="nitro" href="../nitro.html" class="link-footer">Nitro</a><a data-track="status" href="https://discordstatus.com/" class="link-footer">Status</a><a data-track="status" href="../application-directory.html" class="link-footer">App Directory</a><a data-track="status" href="../mobile.html" class="link-footer">New Mobile Experience</a></div><div id="w-node-_4154f574-5821-8ddb-f6fc-12aae7b6c8bf-e7b6c85e"><div class="paragraph-small top-marg font-blue">Company</div><a data-track="about" href="../company.html" class="link-footer">About</a><a data-track="jobs" href="../careers.html" class="link-footer">Jobs</a><a data-track="branding" href="../branding.html" class="link-footer">Brand</a><a data-track="newsroom" href="../newsroom.html" class="link-footer">Newsroom</a><a data-track="newsroom" href="../fallrelease.html" class="link-footer">Fall Release</a></div><div id="w-node-_4154f574-5821-8ddb-f6fc-12aae7b6c8ca-e7b6c85e"><div class="paragraph-small top-marg font-blue">Resources</div><a data-track="college" href="../college.html" class="link-footer">College</a><a data-track="support" href="https://support.discord.com/hc" class="link-footer">Support</a><a data-track="safety" href="../safety.html" class="link-footer">Safety</a><a data-track="blog" href="../blog.html" class="link-footer">Blog</a><a data-track="feedback" href="https://support.discord.com/hc/en-us/community/topics" class="link-footer">Feedback</a><a data-track="streamkit" href="../streamkit.html" class="link-footer">StreamKit</a><a data-track="creators" href="../creators.html" class="link-footer">Creators</a><a data-track="community" href="../community.html" class="link-footer">Community</a><a data-track="Build" href="../build.html" class="link-footer">Developers</a><a data-track="Build" href="../gaming.html" class="link-footer">Gaming</a><a data-track="store" href="https://discordmerch.com/evergreenfooter" class="link-footer">Official 3rd Party Merch</a></div><div id="w-node-_4154f574-5821-8ddb-f6fc-12aae7b6c8e1-e7b6c85e"><div class="paragraph-small top-marg font-blue">Policies</div><a data-track="terms" href="../terms.html" class="link-footer">Terms</a><a data-track="privacy" href="../privacy.html" class="link-footer">Privacy</a><a data-open-cookie-settings="true" href="#" class="link-footer">Cookie Settings</a><a data-track="guidelines" href="../guidelines.html" class="link-footer">Guidelines</a><a data-track="acknowledgement" href="../acknowledgements.html" class="link-footer">Acknowledgements</a><a data-track="licenses" href="../licenses.html" class="link-footer">Licenses</a><a data-track="moderation" href="../safety-library.html" class="link-footer">Moderation</a></div></div><div class="footer-line-blue"><a data-track="logo" href="../index.html" class="w-inline-block"><img src="https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/64cb9ed63bb88490555f45a1_Open Source Projects _ Discord-7.svg" loading="lazy" alt="" class="discord-footer"/></a><a data-track="login_footer" href="../app.html" class="button-white color-blue-right footer-open-discord-button footer-open-discord-button-js w-button">Sign up</a></div></div></div><script src="../../d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c84fb4.js?site=5f8dd67f8fdd6f51f0b50904" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script><script src="../../assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/js/discordpages.790f5716f.js" type="text/javascript"></script><script type="text/javascript" src="../w/loader/loader.js" async defer></script>
<script src="../webflow-scripts/bodyEnd.js" defer async></script>
<script>
  function initDownloadButton() {
    let userAgent = window.navigator.userAgent,
        platform = window.navigator.platform,
        macosPlatforms = ['Macintosh', 'MacIntel', 'MacPPC', 'Mac68K'],
        windowsPlatforms = ['Win32', 'Win64', 'Windows', 'WinCE'],
        iosPlatforms = ['iPhone', 'iPad', 'iPod'],
        buttonAttributes = null;

    if (iosPlatforms.indexOf(platform) !== -1) {
      buttonAttributes = {
        text: "Download on the App Store",
        href: "https://itunes.apple.com/us/app/discord-chat-for-games/id985746746",
      }
    } else if (macosPlatforms.indexOf(platform) !== -1) {
      buttonAttributes = {
        text: "Download for Mac",
        href: "https://discord.com/api/download?platform=osx",
      }
    } else if (windowsPlatforms.indexOf(platform) !== -1) {
      buttonAttributes = {
        text: "Download for Windows",
        href: "https://discord.com/api/download?platform=win",
      }
    } else if (/Android/.test(userAgent)) {
      buttonAttributes = {
        text: "Download on Google Play",
        href: "https://play.google.com/store/apps/details?id=com.discord",
      }
    } else if (!os && /Linux/.test(platform)) {
      buttonAttributes = {
        text: "Download for Linux",
        href: "https://discord.com/api/download?platform=linux",
      }
    }

	let downloadEl = document.querySelectorAll(".download-button");
    if (downloadEl) {
      downloadEl.forEach(function(el) {
        el.innerText = buttonAttributes.text;
        el.href = buttonAttributes.href;
      });
    }

	let downloadSidebarEl = document.querySelectorAll(".download-sidebar");
    if (downloadSidebarEl) {
      downloadSidebarEl.forEach(function(el) {
        el.href = buttonAttributes.href;
      });
    }
  }
  
  function initLogInOrOpenDiscordButton() {
    let loginButtonText, loginRoute, signUpButtonText, signupRoute;
    let loginIsOpenDiscordButton = true;
    const loginLink = '../login.html';
    const signupLink = '../register.html';
    const openLink = '../channels/%40me.html';
    
    if(window.localStorage.getItem("token") != null) {
      loginButtonText = "Open Discord";
      loginRoute = openLink;
      loginIsOpenDiscordButton = true;
      
      signUpButtonText = "Open Discord";
      signupRoute = openLink;
    } else {
      loginIsOpenDiscordButton = false;
      loginButtonText = "Login";
      signUpButtonText = "Sign up";
      loginRoute = loginLink;
      signupRoute = signupLink;
    }
    
    let loginEl = document.querySelectorAll(".login-button-js");
    let footerEl = document.querySelectorAll(".footer-open-discord-button-js");
    if (loginEl && loginEl.length > 0) {
      loginEl.forEach(function(el) {
        if (!loginIsOpenDiscordButton) {
        	el.classList.add('hide-on-mobile');
        }
        el.innerText = loginButtonText;
      	el.href = loginRoute;
        if (loginIsOpenDiscordButton) {
            el.dataset.trackNav = 'navbar-open-button';
        }
      });
    }
    if (footerEl && footerEl.length > 0) {
      footerEl.forEach(function(el) {
        if (window.innerWidth <= 768) {
        	el.innerText = "Download";
        } else {
        	el.innerText = signUpButtonText;
        }
        el.href = signupRoute;
      });
    }
  }
  
  function initSignUpOrOpenButtons() {
    const signupLink = '../register.html';
    const openLink = '../channels/%40me.html';
    const isLoggedIn = window.localStorage.getItem("token") != null;
    const buttonEl = document.querySelectorAll(".open-or-signup-js");
    
    if (buttonEl && buttonEl.length > 0) {
        buttonEl.forEach(function(el) {
            if (isLoggedIn) {
                el.innerText = 'Open Discord';
                el.href = openLink;
            } else {
                el.innerText = 'Sign up';
                el.href = signupLink;
            }
        });
    }
  }
  
  initSignUpOrOpenButtons();
  initLogInOrOpenDiscordButton();
  initDownloadButton();
</script>


<!-- build:inlineScriptNonceTag -->
  <script>
  <!-- endbuild -->
  </script>
  <!-- section:dataLayer -->
  <script src="../assets/oneTrust/v4/scripttemplates/otSDKStub.js" type="text/javascript" charset="UTF-8" data-domain-script="04da1d72-0626-4fff-b3c6-150c719cc115"></script>
  <!-- build:inlineScriptNonceTag -->
  <script>
    <!-- endbuild -->
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({ 'allCookiesOK': false });
  </script>
  <!-- endsection -->
  <!-- section:gtm -->
  <!-- build:inlineScriptNonceTag -->
  <script>
  <!-- endbuild -->
    (function (w, d, s, l, i) {
      w[l] = w[l] || []; w[l].push({
        'gtm.start':
          new Date().getTime(), event: 'gtm.js'
      }); var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
          '../../www.googletagmanager.com/gtm5445.html?id=' + i + dl + '&gtm_auth=GI0g9O-54_SitcgmxQKxlA&gtm_preview=env-2&gtm_cookies_win=x'; f.parentNode.insertBefore(j, f);
    })(window, document, 'script', 'dataLayer', 'GTM-N7BVC2W');
  </script>
  <!-- endsection --><script type="application/ld+json">
{ 
 "@context": "http://schema.org", 
 "@type": "BlogPosting",
 "headline": "Maxjourney: Pushing Discord’s Limits with a Million+ Online Users in a Single Server",
 "image": "https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/62a281f083081c68ebb94672_Discord%20HQ%20-%203.png",
 "publisher": "Discord",
 "url": "https://discord.com/blog/maxjourney-pushing-discords-limits-with-a-million-plus-online-users-in-a-single-server",
 "datePublished": "Nov 13, 2023",
 "dateCreated": "Oct 24, 2023",
 "dateModified": "Nov 13, 2023",
 "description": "In this post, we’ll talk about some of the ways we’ve scaled individual Discord servers from tens of thousands of concurrent users to approaching two million concurrent users in the past few years.",
   "author": {
    "@type": "Person",
    "name": "Yuliy Pisetsky"
  }
 }
</script>

<script nonce="MTcyLDEwNiw0MywxNzQsMjM5LDg5LDE5MiwxODc=">(function(){var js = "window['__CF$cv$params']={r:'83f183fcde7a448a',t:'MTcwNDE4MjkyMS43NzgwMDA='};_cpo=document.createElement('script');_cpo.nonce='MTcyLDEwNiw0MywxNzQsMjM5LDg5LDE5MiwxODc=',_cpo.src='../cdn-cgi/challenge-platform/h/g/scripts/jsd/74bd6362/main.js',document.getElementsByTagName('head')[0].appendChild(_cpo);";var _0xh = document.createElement('iframe');_0xh.height = 1;_0xh.width = 1;_0xh.style.position = 'absolute';_0xh.style.top = 0;_0xh.style.left = 0;_0xh.style.border = 'none';_0xh.style.visibility = 'hidden';document.body.appendChild(_0xh);function handler() {var _0xi = _0xh.contentDocument || _0xh.contentWindow.document;if (_0xi) {var _0xj = _0xi.createElement('script');_0xj.nonce = 'MTcyLDEwNiw0MywxNzQsMjM5LDg5LDE5MiwxODc=';_0xj.innerHTML = js;_0xi.getElementsByTagName('head')[0].appendChild(_0xj);}}if (document.readyState !== 'loading') {handler();} else if (window.addEventListener) {document.addEventListener('DOMContentLoaded', handler);} else {var prev = document.onreadystatechange || function () {};document.onreadystatechange = function (e) {prev(e);if (document.readyState !== 'loading') {document.onreadystatechange = prev;handler();}};}})();</script></body>
<!-- Mirrored from discord.com/blog/maxjourney-pushing-discords-limits-with-a-million-plus-online-users-in-a-single-server by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 02 Jan 2024 08:23:20 GMT -->
</html>